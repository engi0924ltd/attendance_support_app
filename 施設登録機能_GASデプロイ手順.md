# 施設登録機能 GASデプロイ手順

新規施設登録機能を有効にするため、マスター管理用Google Apps Scriptを更新する手順です。

## 前提条件

- マスタースプレッドシートが作成済みであること
- 既存のマスター管理GASがデプロイ済みであること
- テンプレートスプレッドシート（ID: `1GSyuEUl_Jn5NaNUcSEIF8oyqN2H9GTAPzDCbb_7C0_o`）が作成済みであること

## 手順

### 1. Google Apps Scriptエディタを開く

1. マスタースプレッドシートを開く
2. メニューから「拡張機能」→「Apps Script」を選択

### 2. コードを更新

1. 既存の`master_gas_code.js`の内容を、プロジェクトフォルダの`master_gas_code.js`で**完全に置き換え**
   - ファイルパス: `/Users/yamaguchisatoshi/Desktop/attendance_support_app/master_gas_code.js`

### 3. 変更内容の確認

更新された`handleCreateFacility`関数は以下の処理を行います:

```javascript
function handleCreateFacility(data) {
  // 1. バリデーション（必須項目チェック）
  // 2. 施設IDの重複チェック
  // 3. メールアドレスの重複チェック
  // 4. テンプレートスプレッドシートをコピー
  // 5. 施設マスタシートに新しい行を追加
  // 6. 成功レスポンスを返す
}
```

### 4. デプロイ

1. 右上の「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」で「ウェブアプリ」を選択
3. 設定:
   - **説明**: 「施設登録機能追加」など
   - **次のユーザーとして実行**: 「自分」
   - **アクセスできるユーザー**: 「全員」
4. 「デプロイ」をクリック
5. 権限の確認画面で「アクセスを承認」
6. デプロイ完了後、ウェブアプリのURLは**変更されません**（既存のURLをそのまま使用）

### 5. 動作確認

#### Flutterアプリから確認

1. アプリを起動
2. 「管理者メニュー」→ 全権管理者でログイン
3. 全権管理者ダッシュボードで「新規施設登録」ボタンをタップ
4. 施設情報を入力:
   - **必須項目**:
     - 施設ID（厚労省番号）
     - 施設名
     - 施設管理者名
     - メールアドレス
     - パスワード
     - 年度
   - **オプション項目**:
     - 施設住所
     - 施設電話番号
     - 利用者定員
     - 備考
5. 「施設を登録」ボタンをタップ
6. 成功メッセージが表示され、新しいスプレッドシートIDが通知されることを確認

#### スプレッドシートから確認

1. マスタースプレッドシートの「施設マスタ」シートを開く
2. 新しい行が追加されていることを確認
3. F列（スプレッドシートID）に新しいIDが記録されていることを確認
4. Googleドライブで新しいスプレッドシートが作成されていることを確認
   - ファイル名: `{施設名}_マスタ設定_{年度}`

## テンプレートスプレッドシートについて

### デフォルトテンプレート

- スプレッドシートID: `1GSyuEUl_Jn5NaNUcSEIF8oyqN2H9GTAPzDCbb_7C0_o`
- このテンプレートには以下のシートが含まれています:
  - マスタ設定
  - 勤怠_2025
  - 支援記録_2025
  - 名簿_2025
  - 請求_2025

### テンプレートの変更方法

1. マスタースプレッドシートの「施設マスタ」シートを開く
2. R列（テンプレートID）に異なるスプレッドシートIDを設定
3. 今後の新規登録時、そのテンプレートが使用されます

## トラブルシューティング

### エラー: 「テンプレートのコピーに失敗しました」

**原因**: テンプレートスプレッドシートへのアクセス権限がない

**解決方法**:
1. テンプレートスプレッドシート（ID: `1GSyuEUl_Jn5NaNUcSEIF8oyqN2H9GTAPzDCbb_7C0_o`）を開く
2. 「共有」ボタンをクリック
3. GASを実行するGoogleアカウントに編集権限を付与
4. または、テンプレートを「リンクを知っている全員が閲覧可」に設定

### エラー: 「この施設IDは既に登録されています」

**原因**: 同じ施設ID（厚労省番号）が既に存在する

**解決方法**:
- 異なる施設IDを使用
- または、既存の施設情報を確認して重複を解消

### エラー: 「このメールアドレスは既に登録されています」

**原因**: 同じメールアドレスが既に登録されている

**解決方法**:
- 異なるメールアドレスを使用
- または、既存の施設管理者アカウントを確認

## 注意事項

1. **テンプレートの編集**: テンプレートスプレッドシートを編集する場合は、既存の施設に影響しないよう注意してください
2. **権限管理**: 作成されたスプレッドシートは、デフォルトでGASを実行したアカウントの所有になります
3. **バックアップ**: 重要なテンプレートは定期的にバックアップを取ることを推奨します

## 今後の機能拡張

Phase 2以降で以下の機能が追加予定です:

- 施設情報の編集機能
- 施設の無効化/削除機能
- ドライブフォルダの自動作成
- 年度更新機能（次年度への移行）
