# Googleスプレッドシート設定手順

このガイドに従って、アプリとスプレッドシートを連携させましょう。

---

## 📋 ステップ1: スプレッドシートの作成

### 1-1. 新規スプレッドシート作成
1. Google Driveにアクセス: https://drive.google.com
2. 「新規」→「Googleスプレッドシート」→「空白のスプレッドシート」をクリック
3. ファイル名を「B型施設_勤怠管理」などに変更

### 1-2. 必要なシートを作成
デフォルトの「シート1」を以下の3つのシートに変更します：

1. **シート1を右クリック** → 「名前を変更」→ `マスタ設定`
2. 下部の「+」ボタンで新規シート作成 → 名前を `勤怠_2025` に変更
3. もう一度「+」ボタンで新規シート作成 → 名前を `支援記録_2025` に変更

> **ポイント**: 年度が変わったら `勤怠_2026` のように新しいシートを追加します

---

## 📝 ステップ2: マスタ設定シートの作成

`マスタ設定` シートを開いて、以下の内容を入力します。

### 2-1. 利用者マスタ（A列〜F列）

**1行目（ヘッダー）**:
```
A1: ID
B1: 利用者名
C1: フリガナ
D1: 状態
E1: 登録日
F1: 備考
```

**2行目以降（サンプルデータ）**:
```
A2: 1       B2: 山田太郎    C2: ヤマダタロウ    D2: 在籍    E2: 2025-04-01    F2:
A3: 2       B3: 佐藤花子    C3: サトウハナコ    D3: 在籍    E3: 2025-04-01    F3:
A4: 3       B4: 鈴木次郎    C4: スズキジロウ    D4: 在籍    E4: 2025-04-01    F4:
```

> **重要**: D列の「状態」は必ず `在籍` と入力してください（退所した方は `退所` に変更）

---

### 2-2. 職員マスタ（10行目あたりから）

**A10セル**に `職員マスタ` と見出しを入力

**11行目（ヘッダー）**:
```
A11: ID
B11: 職員名
C11: メールアドレス
D11: エイリアス1
E11: エイリアス2
F11: 状態
G11: 権限
```

**12行目以降（サンプルデータ）**:
```
A12: 1    B12: 田中先生    C12: tanaka@example.com    D12:    E12:    F12: 在職    G12: 支援員
A13: 2    B13: 山本先生    C13: yamamoto@example.com  D13:    E13:    F12: 在職    G13: 管理者
```

> **ポイント**: C列のメールアドレスでログインします。D列・E列はメールアドレスの別名（省略可）

---

### 2-3. プルダウン選択肢マスタ（20行目あたりから）

**A20セル**に `プルダウン選択肢マスタ` と見出しを入力

**21行目（ヘッダー）**:
```
A21: カテゴリ
B21: 選択肢
C21: 表示順
D21: 有効/無効
```

**22行目以降（サンプルデータ）**:
```
A22: 利用予定          B22: 通常利用      C22: 1    D22: 有効
A23: 利用予定          B23: 在宅利用      C23: 2    D23: 有効
A24: 出欠（内容）      B24: 出勤          C24: 1    D24: 有効
A25: 出欠（内容）      B25: 欠勤          C25: 2    D25: 有効
A26: 出欠（内容）      B26: 遅刻          C26: 3    D26: 有効
A27: 出欠（内容）      B27: 早退          C27: 4    D27: 有効
A28: 本日の体調        B28: 良好          C28: 1    D28: 有効
A29: 本日の体調        B29: やや不調      C29: 2    D29: 有効
A30: 本日の体調        B30: 不調          C30: 3    D30: 有効
A31: 睡眠状況          B31: 十分          C31: 1    D31: 有効
A32: 睡眠状況          B32: やや不足      C32: 2    D32: 有効
A33: 睡眠状況          B33: 不足          C33: 3    D33: 有効
A34: 特記事項          B34: なし          C34: 1    D34: 有効
A35: 特記事項          B35: 体調不良      C35: 2    D35: 有効
```

必要に応じて選択肢を追加してください。

---

### 2-4. 担当業務マスタ（40行目あたりから）

**A40セル**に `担当業務マスタ` と見出しを入力

**41行目（ヘッダー）**:
```
A41: ID
B41: 業務名
C41: カテゴリ
D41: 表示順
E41: 有効/無効
```

**42行目以降（サンプルデータ）**:
```
A42: 1    B42: 軽作業      C42: 共通    D42: 1    E42: 有効
A43: 2    B43: 梱包作業    C43: 共通    D43: 2    E43: 有効
A44: 3    B44: 清掃作業    C44: 共通    D44: 3    E44: 有効
A45: 4    B45: PC作業      C45: 共通    D45: 4    E45: 有効
```

必要に応じて業務を追加してください。

---

## 📊 ステップ3: 勤怠シートの作成

`勤怠_2025` シートを開いて、1行目にヘッダーを作成します。

### ヘッダー行（1行目）:
```
D1: 日時
E1: 利用者名
F1: 利用予定
G1: 出欠（内容）
H1: 担当業務AM
I1: 担当業務PM
J1: 利用者コメント
K1: 本日の体調
L1: 睡眠状況
M1: 特記事項
N1: 〜R1: （支援者記録欄・任意）
S1: 出勤時間
T1: 退社時間
U1: 昼休憩
V1: （計算用）
W1: 15分休
X1: （計算用）
Y1: 他休憩
Z1: 実労時間
AA1: 〜AB1: （任意）
AC1: 食事提供加算
AD1: 欠席対応加算
AE1: 訪問支援加算
AF1: 送迎加算
```

> **注意**: A〜C列、N〜R列、AA〜AB列は空白または任意の項目で構いません

---

## 🔧 ステップ4: Google Apps Scriptの設定

### 4-1. Apps Scriptエディタを開く
1. スプレッドシート上部のメニュー「拡張機能」をクリック
2. 「Apps Script」をクリック

### 4-2. コードを貼り付け
1. 左側に表示される `コード.gs` をクリック
2. 既存のコード（`function myFunction() {}`）をすべて削除
3. プロジェクトフォルダ内の **`gas_code.js`** の内容をすべてコピー
4. Apps Scriptエディタに貼り付け
5. 上部の「💾保存」ボタンをクリック（またはCtrl+S / Cmd+S）

### 4-3. 年度の設定を確認
コードの6〜10行目付近にある設定を確認：

```javascript
const SHEET_NAMES = {
  MASTER: 'マスタ設定',
  ATTENDANCE: '勤怠_2025',  // ← 作成したシート名と一致させる
  SUPPORT_RECORD: '支援記録_2025'
};
```

シート名を変更した場合は、ここも修正してください。

---

## 🚀 ステップ5: スクリプトのデプロイ

### 5-1. デプロイ設定
1. Apps Scriptエディタ右上の「デプロイ」ボタンをクリック
2. 「新しいデプロイ」を選択
3. 左側の歯車アイコン⚙️をクリック → 「ウェブアプリ」を選択
4. 以下のように設定：
   - **説明**: `B型施設アプリAPI` など任意
   - **次のユーザーとして実行**: `自分`
   - **アクセスできるユーザー**: `全員` ← **重要！**
5. 「デプロイ」ボタンをクリック

### 5-2. 権限の承認
初回デプロイ時に権限の承認が必要です：

1. 「アクセスを承認」をクリック
2. Googleアカウントを選択
3. 「詳細」→「（プロジェクト名）に移動」をクリック
4. 「許可」をクリック

### 5-3. URLをコピー
デプロイが完了すると **「ウェブアプリ URL」** が表示されます：

```
https://script.google.com/macros/s/XXXXXXXXXXXXXXX/exec
```

このURLを**必ずコピー**してください（後で使います）。

> **重要**: このURLを他人に教えないでください

---

## 📱 ステップ6: アプリにURLを設定

### 6-1. 設定ファイルを開く
プロジェクトフォルダの以下のファイルを開きます：
```
lib/config/api_config.dart
```

### 6-2. URLを貼り付け
5行目の `YOUR_SCRIPT_ID` 部分を、ステップ5-3でコピーしたURLに置き換えます：

**変更前**:
```dart
static const String baseUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
```

**変更後**:
```dart
static const String baseUrl = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXX/exec';
```

### 6-3. ファイルを保存
Ctrl+S (Windows/Linux) または Cmd+S (Mac) で保存

---

## ✅ ステップ7: 動作確認

### 7-1. アプリを再起動
ターミナル/コマンドプロンプトで以下を実行：

```bash
cd attendance_support_app
flutter clean
flutter run -d macos
```

### 7-2. テスト
1. アプリが起動したら「利用者メニュー」をタップ
2. マスタ設定で登録した利用者名が表示されることを確認
3. 利用者を選択して出勤登録をテスト
4. スプレッドシートの `勤怠_2025` シートにデータが追加されることを確認

---

## 🔄 スクリプト更新時の手順

コードを修正した場合：

1. Apps Scriptエディタでコードを修正
2. 「💾保存」をクリック
3. 「デプロイ」→「デプロイを管理」をクリック
4. 鉛筆アイコン✏️をクリック
5. バージョンを「新バージョン」に変更
6. 「デプロイ」をクリック

> **注意**: URLは変わりません

---

## 🆘 トラブルシューティング

### エラー: 「シートが見つかりません」
→ シート名が正しいか確認（`マスタ設定`, `勤怠_2025` 等）

### エラー: 「通信エラー」
→ デプロイ設定で「アクセスできるユーザー」が「全員」になっているか確認

### 利用者名が表示されない
→ マスタ設定の「状態」列が `在籍` になっているか確認

### ログインできない
→ 職員マスタにメールアドレスが登録されており、「状態」が `在職` になっているか確認

---

## 📞 サポート

問題が解決しない場合は、以下を開発者に連絡してください：
- エラーメッセージのスクリーンショット
- Apps Scriptの実行ログ（Apps Scriptエディタ → 「実行」→「実行ログを表示」）
