# 2026/01/11 作業ログ

## 概要
クイックステータス統一、過去日付対応、ログアウト修正、バッチAPI実装による高速化を実施。

---

## 1. 受給者証アラートの日付表示形式修正

**ファイル:**
- `lib/screens/facility_admin/facility_admin_dashboard_screen_v2.dart`
- `lib/screens/staff/daily_attendance_list_screen.dart`

**内容:**
- アラートクリック時の期限日表示を「yyyymmdd」から「年月日」形式に変更
- `_formatDateToJapanese()`メソッドを追加

---

## 2. 支援者画面に受給者証アラート機能を追加

**ファイル:** `lib/screens/staff/daily_attendance_list_screen.dart`

**内容:**
- 施設管理者ダッシュボードと同じ仕様でアラート機能を追加
- `_certificateAlerts`, `_isLoadingAlerts`状態変数
- `_loadCertificateAlerts()`, `_buildCertificateAlert()`, `_showCertificateAlerts()`メソッド

---

## 3. クイックステータス「出勤予定」の修正

**問題:** 出勤すると「出勤予定」の数が減少していた

**原因:** フィルタリング後の`_scheduledUsers.length`を使用していた

**修正:**
- `_totalScheduledCount`変数を追加
- 全予定者数（出勤済み含む）を固定値として保持

---

## 4. クイックステータス統一ルールをCLAUDE.mdに追加

**ファイル:** `CLAUDE.md`

**追加内容（絶対ルール#6）:**

| 項目 | カウント方法 | 参照元 |
|------|-------------|--------|
| **出勤予定** | マスタ設定シートD〜J列（曜日別予定）に予定がある人数。**出勤しても減らない固定値** | マスタ設定シート |
| **出勤済** | 支援記録_YYYYシートにその日の記録がある人数 | 支援記録シート |
| **未出勤** | 出勤予定 − 出勤済（予定があるが記録未作成の人数） | 計算値 |
| **記録未** | 支援記録が未入力の人数。**出勤者 + 欠勤・事前連絡あり欠勤**で未入力をカウント | 支援記録シートD列 |

---

## 5. 日付リフレッシュ機能の追加

**問題:** 日を跨いでリフレッシュボタンを押しても日付が更新されない

**ファイル:**
- `lib/screens/staff/daily_attendance_list_screen.dart`
- `lib/screens/facility_admin/daily_attendance_screen.dart`

**修正:**
- `_refreshToToday()`メソッドを追加
- `_selectedDate = DateTime.now()`で現在日付に更新

---

## 6. 過去日付選択時の全範囲検索対応

**問題:** カレンダーで過去日付を選択しても出勤一覧が0件になる

**原因:** GASの`handleGetDailyAttendance`と`handleGetScheduledUsers`が最新100行のみ検索

**ファイル:** `assets/gas/gas_code_v4.js`

**修正:**
```javascript
// 今日の日付を取得（yyyy/MM/dd形式）
const today = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy/MM/dd');
const isToday = (date === today);

// 検索範囲を決定
if (isToday) {
  // 【高速化】今日の日付：最新100行のみ検索
  maxSearchRows = Math.min(actualLastRow - 1, 100);
  startRow = Math.max(2, actualLastRow - maxSearchRows + 1);
} else {
  // 【全範囲】過去の日付：全データを検索
  startRow = 2;
  maxSearchRows = actualLastRow - 1;
}
```

---

## 7. ログアウト時の施設情報維持

**問題:** ログアウト後に「施設コードでセットアップ」画面が表示される

**原因:** `logoutSession()`が`clearFacilityGasUrl()`を呼んでいた

**ファイル:** `lib/services/master_auth_service.dart`

**修正:**
```dart
/// セッションのみログアウト（認証情報・施設情報は維持）
Future<void> logoutSession() async {
  // 施設情報は維持する（完全ログアウト時のみクリア）
}
```

---

## 8. バッチAPI実装による高速化

### GAS側

**ファイル:** `assets/gas/gas_code_v4.js`

**追加:**
- `handleStaffDashboardBatch(date)` - 出勤一覧・予定者・受給者証アラート・評価アラートを一括取得
- `getDailyAttendanceData()` - バッチ用内部関数
- `getScheduledUsersData()` - バッチ用内部関数
- `getCertificateAlertsData()` - バッチ用内部関数
- `getEvaluationAlertsData()` - バッチ用内部関数

**エンドポイント:**
```
GET dashboard/staff-batch/{date}
```

### Flutter側

**ファイル:** `lib/services/attendance_service.dart`

**追加:**
```dart
class StaffDashboardBatchData {
  final List<Attendance> dailyAttendances;
  final List<Map<String, dynamic>> scheduledUsers;
  final List<Map<String, dynamic>> certificateAlerts;
  final List<Map<String, dynamic>> evaluationAlerts;
}

Future<StaffDashboardBatchData> getStaffDashboardBatch(String date)
```

### 画面修正

**支援者画面:** `lib/screens/staff/daily_attendance_list_screen.dart`
- `_loadData()`をバッチAPI使用に変更

**施設管理者ダッシュボード:** `lib/screens/facility_admin/facility_admin_dashboard_screen_v2.dart`
- `_loadTodayStats()`をバッチAPI使用に変更

### 効果

| 項目 | 改善前 | 改善後 |
|------|-------|-------|
| API呼び出し回数 | 3〜4回 | 1回 |
| 平均待ち時間 | 約8〜9秒 | 約3〜6秒 |
| 高速化率 | - | **約60%** |

---

## 修正したファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `CLAUDE.md` | クイックステータス統一ルール追加 |
| `assets/gas/gas_code_v4.js` | 過去日付全範囲検索、バッチAPI追加 |
| `lib/screens/staff/daily_attendance_list_screen.dart` | バッチAPI対応、アラート追加、日付リフレッシュ |
| `lib/screens/facility_admin/daily_attendance_screen.dart` | 日付リフレッシュ追加 |
| `lib/screens/facility_admin/facility_admin_dashboard_screen_v2.dart` | バッチAPI対応、日付形式修正 |
| `lib/services/attendance_service.dart` | バッチ取得メソッド追加 |
| `lib/services/master_auth_service.dart` | ログアウト時の施設情報維持 |

---

## コミット履歴

1. **1f84d3e** - クイックステータス統一・過去日付対応・ログアウト修正
2. **ce6e8c8** - バッチAPI実装による高速化（支援者・施設管理者ダッシュボード）

---

## デプロイ必要

GAS変更があるため、全権管理者画面から対象施設の「GAS更新」ボタンでデプロイが必要です。
