# 複数施設対応 実装計画

## ビジネス要件
- 自施設だけでなく他施設へ展開し、メイン事業の1つにする
- 複数施設を統合管理できるシステム構築
- 施設ごと・年度ごとのスプレッドシート管理

## 権限階層

```
【レベル0】全施設管理アカウント（スーパー管理者）
  └─ すべての施設にアクセス可能
  └─ 新規施設の登録・削除
  └─ すべての機能にアクセス可能

【レベル1】施設管理者アカウント
  └─ 自施設のみアクセス
  └─ 支援者アカウントの作成・編集・削除
  └─ 利用者アカウントの作成・編集・削除
  └─ 統計データの閲覧

【レベル2】支援者アカウント
  └─ 自施設のみアクセス
  └─ 利用者アカウントの作成・編集
  └─ 勤怠データの閲覧・編集
  └─ 統計データは閲覧不可

【レベル3】利用者アカウント
  └─ 自分の出勤・退勤のみ
  └─ 他利用者のデータ閲覧不可
```

## データ管理方式

### マスタデータ管理
- **方式**: スプレッドシート方式
- **構成**: 1つのマスタースプレッドシートで全施設情報を管理

### 利用者認証
- **方式**: パスワード認証
- **UX**: ログイン情報維持機能（SharedPreferences）

### スプレッドシート構造
```
【マスタースプレッドシート】（全施設共通・1つ）
├─ 施設マスタシート
├─ 全施設管理者シート
└─ （その他管理用シート）

【施設別スプレッドシート】（施設ごと・年度ごと）
施設A/
  ├─ 2024年度/勤怠管理スプレッドシート
  └─ 2025年度/勤怠管理スプレッドシート
施設B/
  └─ 2025年度/勤怠管理スプレッドシート
```

## 実装フェーズ

### Phase 1: マスタデータ構造の設計 📊
**目的**: 全施設情報を管理する基盤を構築

**成果物**:
- マスタースプレッドシート設計書
- 施設マスタシート（施設ID、施設名、スプレッドシートID、年度等）
- 全施設管理者シート（メールアドレス、パスワード）
- GASコード（マスター管理API）

**影響範囲**: GAS新規作成、データモデル設計
**規模**: 中規模

---

### Phase 2: 認証・権限システムの実装 🔐
**目的**: 4段階の権限レベルを実装

**成果物**:
- 権限レベル定義（0:全施設管理者、1:施設管理者、2:支援者、3:利用者）
- トークンに施設ID + 権限情報を含める仕組み
- 権限チェック機能（GAS/Flutter）
- 認証サービスの拡張

**影響範囲**: GAS認証ロジック、Flutter認証サービス全体
**規模**: 大規模

---

### Phase 3: 施設登録フロー 🏢
**目的**: 全施設管理者による新規施設の登録

**成果物**:
- 新規施設登録画面（Flutter）
- 施設基本情報入力フォーム
- 施設用スプレッドシート自動生成（GAS + DriveApp）
- 施設管理者アカウント作成機能
- マスタースプレッドシートへの登録

**影響範囲**: GAS（DriveApp連携）、Flutter新規画面
**規模**: 大規模

---

### Phase 4: ログインフローの刷新 🚪
**目的**: 権限に応じた適切な画面遷移

**成果物**:
- アカウント種別選択画面
- 施設選択機能（全施設管理者用）
- 権限に応じた画面遷移ロジック
- ログイン画面の統合

**影響範囲**: Flutter画面フロー全体、ナビゲーション設計
**規模**: 大規模

---

### Phase 5: アカウント管理機能 👥
**目的**: 階層的なアカウント作成・管理

**成果物**:
- 施設管理者用: 支援者・利用者アカウント作成画面
- 支援者用: 利用者アカウント作成画面
- アカウント編集・削除機能
- 権限チェック（作成権限の検証）

**影響範囲**: GAS CRUD操作、Flutter管理画面
**規模**: 大規模

---

### Phase 6: 利用者認証の実装 🔑
**目的**: 利用者の安全なログインと制限

**成果物**:
- 利用者ログイン画面（パスワード認証）
- ログイン情報維持機能
- 利用者は自分の勤怠のみアクセス
- 出勤・退勤画面の権限制御

**影響範囲**: GAS認証、Flutter利用者画面の改修
**規模**: 中規模

---

## 現在の実装状況
- ✅ 単一施設向け勤怠管理機能
- ✅ 支援者ログイン・認証
- ✅ 出勤・退勤機能
- ✅ ログイン情報維持機能

## 次のステップ
**Phase 1開始**: マスタースプレッドシートの設計と実装
