# 作業ログ 2026-01-14

## 概要
統計分析画面に自治体統計機能と年齢別分布機能を追加し、利用者の出勤履歴表示機能を実装しました。

---

## 1. 自治体統計セクションの追加

### 対象画面
- 施設管理者ダッシュボード（`lib/screens/facility_admin/analytics_screen.dart`）
- 支援者画面（`lib/screens/staff/analytics_screen.dart`）

### 機能概要
名簿シートの自治体情報を集計し、4カラムのカードグリッドで表示する機能。

### 表示内容
- **4カラムグリッドレイアウト**: 自治体ごとにカード表示
- **各カードの情報**:
  - 自治体名
  - 該当利用者数
  - 全体に対する割合（%）
- **カラフルなカード**: 8色を循環して使用（blue, green, orange, purple, teal, pink, indigo, amber）

### API
- **GAS**: `analytics/municipality-stats`（`handleGetMunicipalityStats`関数）
- **Flutter**: `AttendanceService.getMunicipalityStats()`

### データソース
- 名簿_YYYYシートのO列（市区町村）

---

## 2. 年齢別分布セクションの追加

### 対象画面
- 施設管理者ダッシュボードのみ（`lib/screens/facility_admin/analytics_screen.dart`）
- ※支援者画面には表示しない

### 機能概要
名簿シートのD列（年齢）を集計し、10代・20代・30代...と年代別に分類して4カラムのカードグリッドで表示する機能。

### 対象利用者
- **契約中・退所済みを問わず、名簿シートに登録のある全利用者**

### 年代分類
| 分類 | 条件 |
|------|------|
| 10歳未満 | 年齢 < 10 |
| 10代 | 10 ≤ 年齢 < 20 |
| 20代 | 20 ≤ 年齢 < 30 |
| 30代 | 30 ≤ 年齢 < 40 |
| ... | ... |
| 90代 | 90 ≤ 年齢 < 100 |
| 100歳以上 | 年齢 ≥ 100 |
| 未設定 | 年齢が空または無効 |

### 表示内容
- **4カラムグリッドレイアウト**: 年代ごとにカード表示
- **各カードの情報**:
  - 年代名（10代、20代など）
  - 該当利用者数
  - 全体に対する割合（%）
- **カラフルなカード**: 12色グラデーション（blue→cyan→teal→green→lime→amber→orange→deepOrange→red→pink→purple→grey）
- **並び順**: 年代順（10歳未満→10代→20代→...→100歳以上→未設定）

### API
- **GAS**: `analytics/age-distribution`（`handleGetAgeDistribution`関数）
- **Flutter**: `AttendanceService.getAgeDistribution()`

### データソース
- 名簿_YYYYシートのB列（氏名）とD列（年齢）

### 年代別利用者一覧ダイアログ
- 年代カードをタップすると、その年代に該当する利用者名の一覧をダイアログで表示
- 利用者名をタップすると、出勤履歴ダイアログへ遷移

---

## 3. 自治体別利用者一覧ダイアログ

### 機能概要
自治体カードをタップすると、その自治体に所属する利用者名の一覧をダイアログで表示。

### 表示内容
- 自治体名（タイトル）
- 利用者数
- 利用者名リスト（タップ可能）

---

## 4. 利用者出勤履歴ダイアログ

### 機能概要
利用者名をタップすると、過去6ヶ月分の出勤履歴を月別に表示。

### API
- **GAS**: `analytics/user-attendance-history/{userName}`（`handleGetUserAttendanceHistory`関数）
- **Flutter**: `AttendanceService.getUserAttendanceHistory()`

### データソース
- 支援記録_YYYYシートのD列（出欠ステータス）
- 対象ステータス: 出勤、施設外、遅刻、早退、在宅

### UI仕様

#### ダイアログ構成
- **タイトル部**: 戻るボタン（←）+ 利用者名
- **コンテンツ**: 月別のExpansionTile

#### 2カラムレイアウト
| 左カラム | 右カラム |
|---------|---------|
| **出勤** | **在宅** |
| 出勤日数 | 在宅日数 |
| 日付一覧（1/1, 1/2...形式） | 日付一覧（1/1, 1/2...形式） |

#### 日付表示仕様
- **形式**: `M/D`（例: 1/12, 2/5）- ゼロパディングなし
- **並び順**: 月内で昇順（1日→31日）
- **ステータス表示**: 遅刻・早退・施設外の場合は日付の後ろに括弧付きで表示
  - 例: `1/15(遅刻)`, `1/20(施設外)`

#### ステータス別カラー
| ステータス | カラー |
|-----------|--------|
| 出勤 | 青（blue） |
| 在宅 | 緑（green） |
| 遅刻 | オレンジ（orange） |
| 早退 | 紫（purple） |
| 施設外 | ティール（teal） |

---

## 5. 修正履歴

### 変更1: 自治体統計UIの実装
- リスト形式から4カラムグリッド形式に変更
- カードタップで利用者一覧ダイアログを表示

### 変更2: 出勤履歴ダイアログのUI改善
1. 戻るボタンをダイアログ左上に追加
2. 日付表示を中央寄せから左寄せに変更
3. 出勤・在宅の2カラムレイアウトに変更

### 変更3: 日付表示の改善
1. 日付形式を`01/12`から`1/12`に変更（ゼロパディング削除）
2. 日付を月内で昇順にソート（1日から順に表示）

### 変更4: 重複ラベルの削除
- ダイアログタイトル右の「出勤 X日 / 在宅 X日」ラベルを削除
- 各カラムヘッダーに日数が表示されるため重複を解消

---

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `assets/gas/gas_code_v4.js` | 年齢別分布API追加（`handleGetAgeDistribution`関数） |
| `lib/services/attendance_service.dart` | `getAgeDistribution()`メソッド追加 |
| `lib/screens/facility_admin/analytics_screen.dart` | 自治体統計・年齢別分布セクション追加、出勤履歴ダイアログ実装 |
| `lib/screens/staff/analytics_screen.dart` | 自治体統計セクション追加、出勤履歴ダイアログ実装（年齢別分布は除外） |

---

## 技術メモ

### MaterialColor vs Color
- `shade700`などのシェードプロパティを使用する場合は`MaterialColor`型が必要
- `Color`型では`shade700`は未定義のためエラーになる

### 日付ソート
```dart
sortedDates.sort((a, b) {
  final dateA = a['date'] as String? ?? '';
  final dateB = b['date'] as String? ?? '';
  return dateA.compareTo(dateB);  // ISO形式（YYYY-MM-DD）は文字列比較でソート可能
});
```

### 日付フォーマット（ゼロパディングなし）
```dart
final month = int.tryParse(dateStr.substring(5, 7)) ?? 0;
final day = int.tryParse(dateStr.substring(8, 10)) ?? 0;
displayDay = '$month/$day';  // 1/12形式
```

### 年齢から年代への分類（GAS）
```javascript
let ageGroup = '未設定';
if (age !== '' && age !== null && !isNaN(age)) {
  const ageNum = parseInt(age);
  if (ageNum < 10) {
    ageGroup = '10歳未満';
  } else if (ageNum >= 100) {
    ageGroup = '100歳以上';
  } else {
    const decade = Math.floor(ageNum / 10) * 10;
    ageGroup = decade + '代';  // 10代、20代、30代...
  }
}
```

### 年代順ソート（GAS）
```javascript
const ageOrder = ['10歳未満', '10代', '20代', '30代', '40代', '50代', '60代', '70代', '80代', '90代', '100歳以上', '未設定'];
stats.sort((a, b) => {
  const indexA = ageOrder.indexOf(a.name);
  const indexB = ageOrder.indexOf(b.name);
  return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
});
```
