# 2026/01/09 作業ログ

## 概要
V2デザインの統一、受給者証期限切れアラート機能の実装、各種バグ修正を実施。

---

## 1. 支援者画面クイックステータスに更新ボタン追加

**ファイル:** `lib/screens/staff/daily_attendance_list_screen.dart`

**内容:**
- 施設管理者ダッシュボードと同様に、クイックステータス画面に更新ボタンを追加
- ローディング状態の管理を`_loadData()`メソッドに集約し、レースコンディションを修正

---

## 2. 施設管理者画面のV2デザイン適用

**ファイル:**
- `lib/screens/superadmin/admin_login_screen.dart`
- `lib/screens/superadmin/super_admin_dashboard_screen.dart`

**内容:**
- `FacilityAdminDashboardScreen` → `FacilityAdminDashboardScreenV2` に変更

---

## 3. 出勤予定者リストの名簿順並び替え

**ファイル:**
- `lib/screens/staff/daily_attendance_list_screen.dart`
- `lib/screens/facility_admin/daily_attendance_screen.dart`

**内容:**
- 出勤予定者リストを名簿順に並び替え
- 出勤済みの人を予定一覧から除外
- フィルタリング: 出勤済み除外 + 名簿順維持

---

## 4. タブカウント表示の追加

**ファイル:**
- `lib/screens/staff/daily_attendance_list_screen.dart`
- `lib/screens/facility_admin/daily_attendance_screen.dart`

**内容:**
- タブに件数を表示: `出勤一覧（2）`、`出勤予定者（3）`

---

## 5. 支援者画面の「記録未」クリック機能追加

**ファイル:** `lib/screens/staff/daily_attendance_list_screen.dart`

**内容:**
- `_notRegisteredUsers`リストを追加
- `_showNotRegisteredUsers()`メソッドを追加（ボトムシートで詳細表示）
- 「記録未」カードをGestureDetectorでラップ
- 施設管理者ダッシュボードと同等の機能を実装

---

## 6. 請求機能のB190/B191修正（他社管理）

**ファイル:** `assets/gas/gas_code_v4.js`

**内容:**
- 他社管理の場合のB190/B191が逆だった問題を修正
- B190: 施設番号（AT列）
- B191: 施設名（AS列）

```javascript
} else if (managementFacilityName || managementFacilityNumber) {
  // 他社管理の場合
  billingSheet.getRange(userBaseRow + 20, 2).setValue(managementFacilityNumber); // B190: 施設番号（AT列）
  billingSheet.getRange(userBaseRow + 21, 2).setValue(managementFacilityName); // B191: 施設名（AS列）
}
```

---

## 7. 施設管理者ダッシュボードの戻るボタン削除

**ファイル:** `lib/theme/app_theme_v2.dart`

**内容:**
- CleanAppBarに`automaticallyImplyLeading: showBackButton`を追加
- `showBackButton: false`が正しく機能するように修正

---

## 8. 受給者証期限切れアラート機能の実装

### GAS側

**ファイル:** `assets/gas/gas_code_v4.js`

**追加内容:**

1. エンドポイント登録（307行目付近）:
```javascript
} else if (action === 'master/certificate-alerts') {
  return handleGetCertificateAlerts();
}
```

2. ハンドラー関数（833行目〜）:
```javascript
function handleGetCertificateAlerts() {
  // 年度を計算（1-3月は前年度、4-12月は当年度）
  const now = new Date();
  const fiscalYear = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;
  const rosterSheetName = `名簿_${fiscalYear}`;

  // AC列（支給決定期間終了）とAE列（適用期間有効期限）をチェック
  // 契約中の利用者で期限切れの人を返す
}
```

**チェック対象:**
- AC列: 支給決定期間（終了）
- AE列: 適用期間有効期限
- 対象: ステータスが「契約中」の利用者のみ
- 条件: 日付が今日以下（当日含む）

### Flutter側

**ファイル:** `lib/services/attendance_service.dart`

**追加内容:**
```dart
/// 受給者証期限切れアラートを取得
Future<List<Map<String, dynamic>>> getCertificateAlerts() async {
  final response = await _apiService.get('master/certificate-alerts');
  final List<dynamic> alerts = response['alerts'] ?? [];
  return alerts.map((e) => Map<String, dynamic>.from(e)).toList();
}
```

**ファイル:** `lib/screens/facility_admin/facility_admin_dashboard_screen_v2.dart`

**追加内容:**
- 状態変数: `_certificateAlerts`, `_isLoadingAlerts`
- `_loadCertificateAlerts()`: 初期化時にアラートを読み込む
- `_buildCertificateAlert()`: ダッシュボード上部に警告カードを表示
- `_showCertificateAlerts()`: クリック時にボトムシートで詳細表示

**表示形式:**
- ダッシュボード: 赤いアラートカード「受給者証の期限切れ（2名）」
- ボトムシート: 各利用者の名前と期限切れ項目（支給決定期間: YYYY/MM/DD）

### デプロイ方法
- **更新対象:** 施設のスプレッドシート（例：「〇〇事業所_2025」）のGAS
- **方法:** 全権管理者画面 → 対象施設の「GAS更新」ボタン

---

## 9. 支援者メニューの施設コードチェック追加

**ファイル:** `lib/screens/common/menu_selection_screen.dart`

**内容:**
- 支援者メニュークリック時に施設コードの設定有無をチェック
- 未設定の場合は施設コード入力画面に遷移
- 「No host specified in URI」エラーを防止

**修正前:**
```dart
void _navigateToStaffMenu() {
  Navigator.push(context, MaterialPageRoute(
    builder: (context) => const StaffLoginScreen(),
  ));
}
```

**修正後:**
```dart
Future<void> _navigateToStaffMenu() async {
  final gasUrl = await _masterAuthService.getFacilityGasUrl();
  if (gasUrl == null || gasUrl.isEmpty) {
    // 施設コード入力画面へ
    Navigator.push(context, MaterialPageRoute(
      builder: (context) => const FacilityCodeSetupScreen(),
    ));
  } else {
    // 支援者ログイン画面へ
    Navigator.push(context, MaterialPageRoute(
      builder: (context) => const StaffLoginScreen(),
    ));
  }
}
```

---

## 10. CLAUDE.mdにGASデプロイルール追加

**ファイル:** `CLAUDE.md`

**追加内容:**
```markdown
### 3. GASデプロイルール（重要）
- **`assets/gas/gas_code_v4.js`** = **施設のスプレッドシート用GAS**
  - 対象シート: マスタ設定、名簿_YYYY、支援記録_YYYY、請求_YYYY など
  - デプロイ方法: 全権管理者画面 → 対象施設の「GAS更新」ボタン
  - **全権管理者シートのGASではない！施設のスプレッドシートのGASを更新する**
- **`master_gas_code_*.js`** = **全権管理者シート用GAS**（通常は編集しない）
- GAS変更後は**必ずどのシートのGASを更新するか明示**すること
```

---

## 修正したファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `lib/screens/staff/daily_attendance_list_screen.dart` | 更新ボタン、記録未クリック、タブカウント、名簿順 |
| `lib/screens/facility_admin/daily_attendance_screen.dart` | タブカウント、名簿順 |
| `lib/screens/facility_admin/facility_admin_dashboard_screen_v2.dart` | 受給者証アラート機能 |
| `lib/screens/superadmin/admin_login_screen.dart` | V2ダッシュボードに変更 |
| `lib/screens/superadmin/super_admin_dashboard_screen.dart` | V2ダッシュボードに変更 |
| `lib/screens/common/menu_selection_screen.dart` | 施設コードチェック追加 |
| `lib/services/attendance_service.dart` | getCertificateAlerts()追加 |
| `lib/theme/app_theme_v2.dart` | automaticallyImplyLeading修正 |
| `assets/gas/gas_code_v4.js` | 請求B190/B191修正、受給者証アラートAPI追加 |
| `CLAUDE.md` | GASデプロイルール追加 |

---

## 未完了・要確認事項

1. **受給者証アラート機能のテスト**
   - 施設のGASを更新後、施設管理者画面でアラートが表示されるか確認
   - 期限切れデータがある利用者がいない場合はアラート非表示

2. **GASデプロイ**
   - 全権管理者画面 → 対象施設の「GAS更新」ボタンで施設GASを更新すること
