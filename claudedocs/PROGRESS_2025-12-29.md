# 実装進捗レポート - 2025-12-29

## 概要

B型施設支援アプリの統計・分析機能強化と職員管理機能の改善を実施。

---

## 本日の実装内容

### 1. 施設情報セクションの追加（管理者画面のみ）

**対象画面**: `lib/screens/facility_admin/analytics_screen.dart`

#### 1.1 施設ごとの延べ人数
- 月別（4月〜3月）で本施設・在宅と施設外の延べ人数を表示
- 合計列を右端に追加

#### 1.2 施設ごとの利用人数平均
- 延べ人数 ÷ 稼働日数で月別平均を表示
- 年間平均（総延べ人数 ÷ 総稼働日数）を右端に追加

#### 1.3 施設ごとの直接処遇職員配置
- 直接処遇職員（生活支援員・職業指導員）の配置を表示
- 本施設・在宅 / 施設外で分類

---

### 2. カウント方法の修正

**対象ファイル**: `assets/gas/gas_code_v4.js`

#### 2.1 当月稼働日数
**変更前**: 出欠が「出勤」「遅刻」の場合のみカウント
**変更後**: 出欠に何か入力があればカウント（全ての出欠種別）

#### 2.2 出勤延べ数
**変更前**: 「出勤」「遅刻」のみ
**変更後**: 「出勤」「在宅」「施設外」「遅刻」「早退」をカウント

#### 2.3 施設情報の実利用数分類
| 出欠の値 | 分類先 |
|---------|--------|
| 出勤 | 本施設・在宅 |
| 在宅 | 本施設・在宅 |
| 遅刻 | 本施設・在宅 |
| 早退 | 本施設・在宅 |
| 施設外 | 施設外 |

---

### 3. 職種フィールドのプルダウン化

**対象ファイル**:
- `assets/gas/gas_code_v4.js`
- `lib/models/dropdown_options.dart`
- `lib/screens/facility_admin/staff_form_screen.dart`

#### 変更内容
- 職種をテキスト入力からプルダウン選択に変更
- 選択肢はマスタ設定シートのAD31:AD40から取得

---

## 修正したファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `assets/gas/gas_code_v4.js` | 稼働日数・延べ人数カウント修正、直接処遇職員配置集計追加、職種ドロップダウン追加 |
| `lib/models/dropdown_options.dart` | jobTypesフィールド追加 |
| `lib/screens/facility_admin/analytics_screen.dart` | 施設情報セクション追加（延べ人数、平均、直接処遇職員配置） |
| `lib/screens/facility_admin/staff_form_screen.dart` | 職種をプルダウン選択に変更 |
| `lib/screens/staff/analytics_screen.dart` | 施設情報セクションを削除（管理者のみに限定） |

---

## シート構成

### マスタ設定シート - 職員関連

| 列 | 内容 | 行範囲 |
|----|------|--------|
| AC列 | 勤務地選択肢 | 8〜15行 |
| AC列 | 資格選択肢 | 20〜30行 |
| AC列 | 職員配置選択肢 | 32〜40行 |
| AD列 | 職種選択肢 | 31〜40行 |

### 職員データ（V〜AB列、7行目〜）

| 列 | 内容 |
|----|------|
| V列 | 職員名 |
| W列 | 権限 |
| X列 | メールアドレス |
| Y列 | パスワード |
| Z列 | 職種 |
| AA列 | 保有福祉資格 |
| AB列 | 職員配置 |

---

## 表示イメージ

### 施設情報セクション（管理者画面）

```
施設情報                          [2024年度]
─────────────────────────────────────────
📊 施設ごとの延べ人数

        | 4月 | 5月 | ... | 3月 | 合計 |
本施設  |  25 |  30 | ... |  32 | 350  |
在宅    |     |     |     |     |      |
施設外  |   5 |   8 | ... |   7 |  75  |

📈 施設ごとの利用人数平均

        | 4月 | 5月 | ... | 3月 | 年間 |
本施設  | 1.3 | 1.5 | ... | 1.6 | 1.4  |
在宅    |     |     |     |     |      |
施設外  | 0.3 | 0.4 | ... | 0.4 | 0.3  |

👥 施設ごとの直接処遇職員配置

┌─────────────┬──────┐
│ 配置場所     │ 人数 │
├─────────────┼──────┤
│ 本施設・在宅 │   3  │
├─────────────┼──────┤
│ 施設外       │   1  │
└─────────────┴──────┘
```

---

## 直接処遇職員の判定ロジック

```javascript
// 直接処遇職員 = 生活支援員 または 職業指導員
if (jobType === '生活支援員' || jobType === '職業指導員') {
  // 配置場所で分類
  if (placement && placement.includes('本施設')) {
    directSupportFacilityHome++;
  } else {
    directSupportExternal++;
  }
}
```

---

## GitHubコミット

**コミットメッセージ**:
```
施設情報セクションと職種プルダウンを追加

- 管理者画面に施設情報セクションを追加（施設ごとの延べ人数、利用人数平均、直接処遇職員配置）
- 稼働日数・出勤延べ数のカウント方法を修正
- 職種フィールドをプルダウン選択に変更（AD31:AD40から取得）
- 延べ人数と平均テーブルに合計/年間列を追加
```

**コミットハッシュ**: `126d7f9`

---

---

### 4. プルダウン範囲の変更

**対象ファイル**: `assets/gas/gas_code_v4.js`

#### 変更内容
職員関連・評価関連のプルダウン取得範囲を変更

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| 勤務地 | AC8:AC15 | W44:W55 |
| 資格選択肢 | AC20:AC30 | T44:T55 |
| 職員配置選択肢 | AC32:AC40 | U44:U55 |
| 職種 | AD31:AD40 | V44:V55 |
| 勤怠評価 | AD8:AD25 | AE30:AE40 |

---

### 5. 職員情報に雇用形態・退職日を追加

**対象ファイル**:
- `assets/gas/gas_code_v4.js`
- `lib/models/staff.dart`
- `lib/models/dropdown_options.dart`
- `lib/services/staff_service.dart`
- `lib/screens/facility_admin/staff_form_screen.dart`

#### 変更内容

| 項目 | 詳細 |
|------|------|
| 職員データ列追加 | AC列: 雇用形態、AD列: 退職日 |
| 雇用形態プルダウン | X44:X55から選択肢取得 |
| 退職日入力 | 8桁の数字形式（例: 20251231） |

#### 職員データ列構成（更新後）
| 列 | 内容 |
|----|------|
| V列 | 職員名 |
| W列 | 権限 |
| X列 | メールアドレス |
| Y列 | パスワード |
| Z列 | 職種 |
| AA列 | 保有福祉資格 |
| AB列 | 職員配置 |
| AC列 | 雇用形態（新規） |
| AD列 | 退職日（新規） |

---

### 6. 直接処遇職員配置テーブルの雇用形態別表示

**対象ファイル**:
- `assets/gas/gas_code_v4.js`
- `lib/screens/facility_admin/analytics_screen.dart`

#### 変更内容

直接処遇職員（生活支援員・職業指導員）の配置を雇用形態別に分類して表示

| 雇用形態 | 説明 |
|---------|------|
| 常勤職員 | 雇用形態に「常勤」を含む |
| 非常勤職員（2日以下） | 雇用形態に「2日以下」を含む |
| 非常勤職員（3日以上） | 雇用形態に「3日以上」を含む |

#### 表示イメージ

```
👥 施設ごとの直接処遇職員配置

┌─────────────┬──────────┬────────┐
│ 雇用形態     │ 本施設   │ 施設外 │
│             │ 在宅     │        │
├─────────────┼──────────┼────────┤
│ 常勤職員     │    2    │   0    │
├─────────────┼──────────┼────────┤
│ 非常勤       │    1    │   0    │
│ (2日以下)   │         │        │
├─────────────┼──────────┼────────┤
│ 非常勤       │    0    │   1    │
│ (3日以上)   │         │        │
├─────────────┼──────────┼────────┤
│ 合計         │    3    │   1    │
└─────────────┴──────────┴────────┘
```

#### GASレスポンス構造

```javascript
directSupportStaff: {
  facilityHome: 3,  // 合計（後方互換性）
  external: 1,       // 合計（後方互換性）
  byEmploymentType: {
    fullTime: { facilityHome: 2, external: 0 },      // 常勤職員
    partTimeLess2: { facilityHome: 1, external: 0 }, // 非常勤（2日以下）
    partTimeMore3: { facilityHome: 0, external: 1 }  // 非常勤（3日以上）
  }
}
```

---

## 次回作業予定

- [ ] 必要に応じて追加の統計項目
- [ ] 支援記録機能の改善
- [ ] その他ユーザー要望対応

---

**最終更新**: 2025-12-29
**作成者**: Claude Code
