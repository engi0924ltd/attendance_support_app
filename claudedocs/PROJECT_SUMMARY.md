# 出勤支援アプリ プロジェクトサマリー

## 絶対ルール

### 1. パフォーマンス最優先
**アプリとGASの読み込み・書き出し速度を何より優先する**
- 一括取得・一括書き込みを使用
- 不要なAPI呼び出しを避ける
- キャッシュを活用
- ループ内でのgetRange/setValueを避ける

### 2. GASファイル編集ルール
- **編集対象**: `assets/gas/gas_code_v4.js`
- **編集禁止**: ルート直下の `gas_code_v4.js`, `master_gas_code_*.js` は**バックアップ専用**

### 3. 請求シート変更時の注意 ※請求シートを変更する際に参照
**請求シートの行構成を変更する場合、以下を確認・更新すること**
- マスタ設定シートの「請求行設定」（U61〜U93, V〜W列）を更新
- 下記「請求シート出力設定」セクションを参照

**【必須】請求シート変更時はユーザーに以下を提案すること：**
1. **再度ハードコードする** - GASの値を直接書き換える（シンプルだが変更の度に修正が必要）
2. **マスタ設定タブ対応に変更する** - マスタ設定シートから設定値を読み取る仕様に変更（柔軟だが実装工数が必要）

※必ず両方の選択肢を提示し、ユーザーに選択してもらうこと

---

## シート構成

### 1. 全権管理者シート - 施設マスタ

| 列 | フィールド名 | 説明 |
|---|---|---|
| A | FACILITY_ID | 施設ID（厚労省番号） |
| B | FACILITY_NAME | 施設名 |
| C | ADMIN_NAME | 施設管理者名 |
| D | ADMIN_EMAIL | 施設メールアドレス |
| E | ADMIN_PASSWORD | 管理者パスワード |
| F | SPREADSHEET_ID | スプレッドシートID |
| G | FISCAL_YEAR | 年度 |
| H | CREATED_AT | 作成日時 |
| I | UPDATED_AT | 更新日時 |
| J | STATUS | ステータス |
| K | CHATWORK_API_KEY | ChatWork APIキー |
| L | DRIVE_FOLDER_ID | ドライブフォルダID |
| M | ADDRESS | 施設住所 |
| N | PHONE | 施設電話番号 |
| O | CONTRACT_START | 契約開始日 |
| P | CONTRACT_END | 契約終了日 |
| Q | CAPACITY | 利用者定員 |
| R | TEMPLATE_ID | テンプレートID |
| S | GAS_URL | GAS URL |
| T | TIME_ROUNDING | 時間設定 |
| U | FACILITY_CODE | 施設コード |
| V | FACILITY_PASSWORD | 施設パスワード |
| W | GAS_URL_2026 | 2026年度GAS URL |
| X | GAS_URL_2027 | 2027年度GAS URL |
| Y〜AJ | GAS_URL_20XX | 年度別GAS URL（2028〜2039年） |

---

### 2. マスタ設定シート

#### 利用者データ（8行目〜、A〜J列）
| 列 | フィールド名 |
|---|---|
| A | 利用者名 |
| B | フリガナ |
| C | 契約状態 |
| D〜J | 曜日別出欠予定（月〜日） |

#### 職員データ（8〜40行目、V〜AD列）
| 列 | フィールド名 |
|---|---|
| V | 職員名 |
| W | 権限 |
| X | メールアドレス |
| Y | パスワード |
| Z | 職種 |
| AA | 保有福祉資格 |
| AB | 職員配置 |
| AC | 雇用形態 |
| AD | 退職日 |

---

### 3. 支援記録_2025シート

| 列 | フィールド名 |
|---|---|
| A | 日時 |
| B | 利用者名 |
| C | 出欠（予定） |
| D | 出欠 |
| E | 担当業務AM |
| F | 担当業務PM |
| G | 業務連絡 |
| H | 本日の体調 |
| I | 睡眠状況 |
| J | 出勤時コメント |
| K | 疲労感 |
| L | 心理的負荷 |
| M | 退勤時コメント |
| N-O | （予備） |
| P | 勤務開始時刻 |
| Q | 勤務終了時刻 |
| R | 昼休憩 |
| S | 15分休憩 |
| T | 他休憩時間 |
| U | 実労時間 |
| V | 食事提供 |
| W | 欠席対応 |
| X | 訪問支援 |
| Y | 送迎 |
| Z | 本人の状況 |
| AA | 勤務地 |
| AB | 記録者 |
| AC | （予備） |
| AD | 在宅支援評価対象 |
| AE | 施設外評価対象 |
| AF | 作業目標 |
| AG | 勤務評価 |
| AH | 就労評価 |
| AI | 就労意欲 |
| AJ | 通信連絡対応 |
| AK | 評価 |
| AL | 利用者の感想 |

---

### 4. 名簿_2025シート（主要列）

| 列 | フィールド名 |
|---|---|
| A | 人数 |
| B | 氏名 |
| C | 氏名カナ |
| D | 年齢 |
| E | ステータス |
| F | 携帯電話番号 |
| G | ChatWorkルームID |
| H | mail |
| I〜BH | その他詳細情報 |

---

### 5. 請求_2025シート - 出力設定 ※請求シートを変更する際に参照

#### 現在のGASハードコード値
| 設定名 | 値 | 説明 |
|---|---|---|
| baseRow | 170 | 1人目の氏名出力行 |
| interval | 78 | 各利用者ブロックの行間隔 |
| dayBaseOffset | 42 | 氏名行から1日目までのオフセット |

**N人目の計算式**: `aₙ = 170 + 78(n−1)`

#### マスタ設定シートの請求行設定（U61〜U93, V〜W列）

| 行 | U列（項目名） | V列（1人目） | W列（2人目） | 名簿シート参照列 |
|---|---|---|---|---|
| 61 | 氏名 | B170 | B248 | B列 |
| 62 | 氏名カナ | B171 | B249 | C列 |
| 63 | 受給者証番号 | B172 | B250 | ※テキスト保持（'付与） |
| 64 | 支給市町村 | B173 | B251 | 市+区を結合 |
| 65 | 障害支援区分 | B174 | B252 | - |
| 66 | 利用者負担上限額 | B175 | B253 | AK列 ※テキスト保持（'付与） |
| 67 | サービス開始日 | B176 | B254 | - |
| 68 | サービス終了日 | B177 | B255 | スキップ |
| 69 | 契約記入欄番号 | B178 | B256 | 固定値「1」 |
| 70 | 契約日 | B179 | B257 | - |
| 71 | 契約終了日 | B180 | B258 | スキップ |
| 72 | 受給者証有効期限 | B181 | B259 | - |
| 73 | 利用者負担上限額有効期限 | B182 | B260 | - |
| 74 | 契約支給量 | B183 | B261 | - |
| ... | ... | ... | ... | ... |
| 93 | 各月1日目 | C212 | C290 | - |

#### 支援記録からの出力（日別データ：1〜31日）

| 請求シート列 | 出力内容 | 支援記録シート参照列 | 変換処理 |
|---|---|---|---|
| C列 | 出欠 | D列 | 「出勤」「在宅」「施設外」「遅刻」「早退」→「○」 |
| D列 | 開始時刻 | P列 | 「12:00」→「1200」（コロン除去） |
| E列 | 終了時刻 | Q列 | 「12:00」→「1200」（コロン除去） |
| S列 | 勤務地 | AA列 | そのまま出力 |

**日付行の計算**: 1日目 = 氏名行 + 42（dayBaseOffset）

#### GAS関数（assets/gas/gas_code_v4.js）

| 関数名 | 用途 |
|---|---|
| handleExecuteBilling | 請求データ出力メイン処理 |
| getValueOrEmpty | null/undefined/空文字→空欄、「0」は保持 |
| getValueAsText | 先頭に「'」付与してテキスト保持（B172, B175で使用） |
| formatTimeToHHMM | 時刻をHHMM形式に変換（Date/文字列/シリアル値対応） |

#### 市町村出力設定

| 設定名 | 値 | 説明 |
|---|---|---|
| municipalityBaseRow | 54 | 1件目の市町村出力行 |
| municipalityInterval | 4 | 各市町村ブロックの行間隔 |
| municipalityMaxCount | 29 | 最大件数（A169以下に収める） |

**N件目の計算式**: `市町村行 = 54 + 4(N−1)`、`市町村番号行 = 市町村行 + 1`

| 出力先 | 内容 | データソース |
|---|---|---|
| A列 | 「市町村」「市町村番号」ラベル | 固定値 |
| B列 | 市町村名、市町村番号 | マスタ設定Q61:R90 |

#### クリア処理

| 対象 | クリア範囲 | 説明 |
|---|---|---|
| 市町村 | A54〜B167（29件分） | A列・B列、全ブロッククリア |
| 利用者ブロック | B列14行、C〜E列31行、S列31行 | 全ブロッククリア（clearMaxUsers） |

**クリアタイミング**: 出力前に全ブロックをクリア（前回出力分も含めて完全クリア）

---

## プルダウン設定（マスタ設定シート）

### 出勤・退勤関連（N〜O列）
| 行範囲 | 列 | 内容 |
|---|---|---|
| 8〜17 | N | 本日の体調 |
| 8〜17 | O | 睡眠状況 |
| 31〜40 | N | 疲労感 |
| 31〜40 | O | 心理的負荷 |

### 職員関連（T〜X列）
| 行範囲 | 列 | 内容 |
|---|---|---|
| 44〜55 | T | 資格選択肢 |
| 44〜55 | U | 職員配置選択肢 |
| 44〜55 | V | 職種 |
| 44〜55 | W | 勤務地 |
| 44〜55 | X | 雇用形態 |

### 評価関連（AE列）
| 行範囲 | 列 | 内容 |
|---|---|---|
| 30〜40 | AE | 勤怠評価 |

### 利用者・名簿関連（K〜S列）
| 行範囲 | 列 | 内容 |
|---|---|---|
| 44〜55 | K | 曜日別出欠予定 |
| 44〜50 | L | ステータス |
| 44〜50 | M | 生活保護 |
| 44〜50 | N | 障がい者手帳年金 |
| 44〜50 | O | 障害等級 |
| 44〜50 | P | 障害種別 |
| 44〜50 | Q | 障害支援区分 |
| 44〜50 | R | 契約形態 |
| 44〜50 | S | 定着支援有無 |

---

## 実装状況

詳細は `claudedocs/IMPLEMENTATION_STATUS.md` を参照

### 完了済み機能
- [x] 利用者機能（出勤/退勤登録）
- [x] 支援者機能（勤怠管理、支援記録、分析、Chatwork連絡）
- [x] 施設管理者機能（職員管理、利用者管理、統計分析）
- [x] 全権管理者機能（施設管理）
- [x] Chatwork一斉送信（GASエンドポイント含む）
- [x] GASパフォーマンス最適化
- [x] 次年度更新機能（スプレッドシート作成、利用者コピー、GASセットアップウィザード）
- [x] 退職済み職員のログイン拒否
- [x] 請求業務機能（設定画面、請求データ出力、市町村管理）

---

## ファイルパス

### 編集対象GAS
```
assets/gas/gas_code_v4.js
```

### 編集禁止（バックアップ）
```
gas_code_v4.js
master_gas_code_final.js
```
