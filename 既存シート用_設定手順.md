# 既存シート用 アプリ設定手順

既にGoogleスプレッドシートを作成済みの方向けの設定手順です。

---

## ✅ 前提条件

以下のシート構成が既に完成していることを確認してください：

### 📋 マスタ設定シート

**A〜C列**: 利用者マスタ（動的）
- 6行目: ヘッダー（利用者名, フリガナ, 契約状態）
- 7行目: 空白
- 8行目〜: 利用者データ（アプリから登録されるたびに行が追加される）

**D〜N列**: プルダウン選択肢
- 6行目: ヘッダー（出欠（予定）, 出欠, 担当業務AM, 担当業務PM, 本日の体調, 睡眠状況, 勤務開始時刻, 勤務終了時刻, 昼休憩, 15分休憩, 他休憩時間）
- 7行目: 空白
- 8〜29行目: 各列のプルダウン選択肢リスト

**P〜AB列**: 支援記録セクション
- 6行目: ヘッダー（職員名, 権限, ログインメールアドレス, ...）
- 7行目: 空白
- 8〜12行目: 職員データ
- 13行目以降: 評価選択肢

### 📊 勤怠_2025シート
- 1行目: ヘッダー行
- 2行目以降: 日々の勤怠データ（アプリから登録されるたびに行が追加される）

---

## 🔧 ステップ1: Google Apps Scriptの設定

### 1-1. Apps Scriptエディタを開く
1. スプレッドシート上部のメニュー「拡張機能」をクリック
2. 「Apps Script」をクリック

### 1-2. コードを貼り付け
1. 左側に表示される `コード.gs` をクリック
2. 既存のコード（`function myFunction() {}`）をすべて削除
3. プロジェクトフォルダ内の **`gas_code_v2.js`** の内容をすべてコピー
4. Apps Scriptエディタに貼り付け
5. 上部の「💾保存」ボタンをクリック（またはCtrl+S / Cmd+S）

### 1-3. シート名の確認
コードの7〜11行目を確認し、シート名が一致しているか確認：

```javascript
const SHEET_NAMES = {
  MASTER: 'マスタ設定',
  ATTENDANCE: '勤怠_2025',
  SUPPORT: '支援記録_2025'
};
```

シート名が異なる場合は、ここを修正してください。

---

## 🚀 ステップ2: スクリプトのデプロイ

### 2-1. デプロイ設定
1. Apps Scriptエディタ右上の「デプロイ」ボタンをクリック
2. 「新しいデプロイ」を選択
3. 左側の歯車アイコン⚙️をクリック → 「ウェブアプリ」を選択
4. 以下のように設定：
   - **説明**: `B型施設アプリAPI v2` など任意
   - **次のユーザーとして実行**: `自分`
   - **アクセスできるユーザー**: `全員` ← **重要！**
5. 「デプロイ」ボタンをクリック

### 2-2. 権限の承認
初回デプロイ時に権限の承認が必要です：

1. 「アクセスを承認」をクリック
2. Googleアカウントを選択
3. 「詳細」→「（プロジェクト名）に移動」をクリック
4. 「許可」をクリック

### 2-3. URLをコピー
デプロイが完了すると **「ウェブアプリ URL」** が表示されます：

```
https://script.google.com/macros/s/XXXXXXXXXXXXXXX/exec
```

このURLを**必ずコピー**してください（次のステップで使います）。

---

## 📱 ステップ3: アプリにURLを設定

### 3-1. 設定ファイルを開く
プロジェクトフォルダの以下のファイルを開きます：
```
lib/config/api_config.dart
```

### 3-2. URLを貼り付け
5行目の `YOUR_SCRIPT_ID` 部分を、ステップ2-3でコピーしたURLに置き換えます：

**変更前**:
```dart
static const String baseUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
```

**変更後**:
```dart
static const String baseUrl = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXX/exec';
```

### 3-3. ファイルを保存
Ctrl+S (Windows/Linux) または Cmd+S (Mac) で保存

---

## ✅ ステップ4: 動作確認

### 4-1. アプリを再起動
ターミナル/コマンドプロンプトで以下を実行：

```bash
cd attendance_support_app
flutter clean
flutter run -d macos
```

### 4-2. テスト手順

#### テスト1: 利用者一覧の確認
1. アプリが起動したら「利用者メニュー」をタップ
2. マスタ設定のA7〜A13で「契約中」の利用者が表示されることを確認

#### テスト2: 出勤登録
1. 利用者を選択
2. 各項目を入力（プルダウンに選択肢が表示されることを確認）
3. 「出勤する」をタップ
4. スプレッドシートの「勤怠_2025」シートにデータが追加されることを確認

#### テスト3: 職員ログイン
1. アプリのメニューに戻る
2. 「支援者メニュー」をタップ
3. マスタ設定のR8〜R12に登録されているメールアドレスでログイン
4. 当日の勤怠一覧が表示されることを確認

---

## 🔄 スクリプト更新時の手順

コードを修正した場合：

1. Apps Scriptエディタでコードを修正
2. 「💾保存」をクリック
3. 「デプロイ」→「デプロイを管理」をクリック
4. 鉛筆アイコン✏️をクリック
5. バージョンを「新バージョン」に変更
6. 「デプロイ」をクリック

> **注意**: URLは変わりません

---

## 🆘 トラブルシューティング

### エラー: 「利用者が表示されない」
→ 以下を確認：
1. マスタ設定のC列（契約状態）が `契約中` になっているか
2. A列（利用者名）に名前が入力されているか
3. 8行目以降にデータがあるか

### エラー: 「プルダウンが空」
→ 以下を確認：
1. マスタ設定のD〜N列の8〜29行目に選択肢が入力されているか
2. 空白セルが多い場合は、選択肢が正しく入力されているか確認

### エラー: 「ログインできない」
→ マスタ設定のR列（ログインメールアドレス）に正しいメールアドレスが登録されているか確認

### エラー: 「出勤登録できない」
→ Apps Scriptの実行ログを確認：
1. Apps Scriptエディタで「実行」→「実行ログを表示」
2. エラーメッセージを確認

### エラー: 「通信エラー」
→ 以下を確認：
1. デプロイ設定で「アクセスできるユーザー」が「全員」になっているか
2. `lib/config/api_config.dart` のURLが正しいか
3. インターネット接続が正常か

---

## 📊 データ構造の確認

### マスタ設定シート - 利用者マスタ（A〜C列）
```
A6: 利用者名         B6: フリガナ           C6: 契約状態
A7: （空白）         B7: （空白）           C7: （空白）
A8: 利用者1          B8: リヨウシャイチ     C8: 契約中
A9: 利用者2          B9: リヨウシャニ       C9: 契約中
...（アプリから登録されるたびに追加）
```

### マスタ設定シート - プルダウン選択肢（D〜N列）
```
D6: 出欠（予定）     E6: 出欠             F6: 担当業務AM    ...
D7: （空白）         E7: （空白）          F7: （空白）
D8: 非利用日         E8: 非利用日          F8: 梱包作業
D9: 出勤             E9: 出勤              F9: 軽作業
D10: 在宅            E10: 在宅             F10: 写真撮影
...
D29: （最終行）
```

### マスタ設定シート - 職員マスタ（P〜AB列）
```
P6: 職員名    Q6: 権限    R6: ログインメールアドレス    ...
P7: （空白）  Q7: （空白）  R7: （空白）
P8: 職員1     Q8: 管理者   R8: 1@test.com
P9: 職員2     Q9: 従業員   R9: 2@test.com
...
```

### 勤怠_2025シート
```
D1: 日時    E1: 利用者名    F1: 出欠（予定）    G1: 出欠    ...
D2: 2025-12-05    E2: 利用者1    F2: 出勤    G2: 出勤    ...
...（アプリから登録されるたびに追加）
```

---

## 📞 サポート

問題が解決しない場合は、以下を開発者に連絡してください：
- エラーメッセージのスクリーンショット
- Apps Scriptの実行ログ
- マスタ設定シートのスクリーンショット
